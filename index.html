<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYTO-Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark Theme Colors */
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg: #1f2937;
            --border-color: #374151;
            --input-bg: #374151;
            --input-border: #4b5563;
            --hover-bg: #1f2937;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
        }
        html:not(.dark) {
            /* Light Theme Colors */
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --hover-bg: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            color: var(--accent-pink);
            border-bottom-color: var(--accent-pink);
        }
        .tab-button:not(.active):hover {
            background-color: var(--hover-bg);
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
        }
        .input-field {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            color: var(--text-color);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px #0e7490;
        }
        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: var(--accent-cyan);
            color: white;
        }
        .btn-primary:hover {
            background-color: #0891b2;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .prognosis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .progress-bar {
            background-color: var(--input-bg);
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }
        .progress-bar-inner {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
        }
        @keyframes highlight-form {
            from {
                border-color: var(--accent-cyan);
                box-shadow: 0 0 8px rgba(6, 182, 212, 0.5);
            }
            to {
                border-color: var(--border-color);
                box-shadow: none;
            }
        }
        .form-highlight {
            animation: highlight-form 1s ease-out;
        }
        .notification {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-in-out;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.error {
            background-color: #dc2626; /* btn-danger red */
        }
        .main-header-title { color: #ffffff; }
        .main-header-subtitle { color: #9ca3af; } /* text-gray-400 */
        html:not(.dark) .main-header-title { color: #111827; } /* text-gray-900 */
        html:not(.dark) .main-header-subtitle { color: #6b7280; } /* text-gray-500 */
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="notification-container" class="fixed top-5 right-5 z-50 space-y-2 w-full max-w-xs"></div>
    <div class="max-w-7xl mx-auto">
        <header class="relative text-center mb-8">
            <h1 class="main-header-title text-3xl md:text-4xl font-bold"><span data-lang="title">AYTO-Calculator</span></h1>
            <p class="main-header-subtitle text-lg mt-1" data-lang="subtitle">Match Rechner & Prognose-Tool</p>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                <button id="theme-toggle" class="p-2 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white transition">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sun-fill hidden" viewBox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162h1.212a.217.217 0 0 1 .134.386l-1.002.725.387 1.162a.217.217 0 0 1-.316.228l-1.001-.725-1.002.725a.217.217 0 0 1-.316-.228l.387-1.162-1.002-.725a.217.217 0 0 1 .134-.386h1.212l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a.796.796 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a.796.796 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></svg>
                </button>
                <button id="lang-toggle" class="p-2 w-10 text-center rounded-full text-sm font-semibold text-gray-400 hover:bg-gray-700 hover:text-white transition">DE</button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-700">
            <nav class="flex -mb-px space-x-4" id="tab-navigation">
                <button data-tab="kandidaten" class="tab-button active text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_contestants">Kandidaten</button>
                <button data-tab="matchboxen" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_matchboxes">Matchboxen</button>
                <button data-tab="matching-nights" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_matching_nights">Matching Nights</button>
                <button data-tab="prognose" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_prognosis">Prognose</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main id="tab-content">
            <!-- Kandidaten Tab -->
            <div id="kandidaten" class="tab-pane">
                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-4" data-lang="add_contestant_title">Neuen Kandidaten hinzufügen</h2>
                    <form id="add-contestant-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="w-full">
                            <label for="name" class="block text-sm font-medium mb-1" data-lang="label_name">Name</label>
                            <input type="text" id="name" name="name" class="input-field w-full px-3 py-2" required>
                        </div>
                        <div class="w-full">
                            <label for="gender" class="block text-sm font-medium mb-1" data-lang="label_gender">Geschlecht</label>
                            <select id="gender" name="gender" class="input-field w-full px-3 py-2" required>
                                <option value="male" data-lang="gender_male">Männlich</option>
                                <option value="female" data-lang="gender_female">Weiblich</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full py-2" data-lang="btn_add">Hinzufügen</button>
                    </form>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3" data-lang="title_men">Männer</h3>
                        <div id="male-contestants" class="space-y-3"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3" data-lang="title_women">Frauen</h3>
                        <div id="female-contestants" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Matchboxen Tab -->
            <div id="matchboxen" class="tab-pane hidden">
                 <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4" data-lang="add_matchbox_title">Matchbox Ergebnis hinzufügen</h2>
                    <form id="add-matchbox-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="mb-male" class="block text-sm font-medium mb-1" data-lang="label_man">Mann</label>
                            <select id="mb-male" class="input-field w-full px-3 py-2"></select>
                        </div>
                         <div>
                            <label for="mb-female" class="block text-sm font-medium mb-1" data-lang="label_woman">Frau</label>
                            <select id="mb-female" class="input-field w-full px-3 py-2"></select>
                        </div>
                         <div>
                            <label for="mb-result" class="block text-sm font-medium mb-1" data-lang="label_result">Ergebnis</label>
                            <select id="mb-result" class="input-field w-full px-3 py-2">
                                <option value="perfect" data-lang="result_perfect_match">Perfect Match</option>
                                <option value="no_match" data-lang="result_no_match">No Match</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full py-2" data-lang="btn_save">Speichern</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3" data-lang="title_previous_matchboxes">Bisherige Matchboxen</h3>
                    <div id="matchbox-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Matching Nights Tab -->
            <div id="matching-nights" class="tab-pane hidden">
                <div id="mn-form-card" class="card p-6 mb-6">
                    <h2 id="mn-form-title" class="text-xl font-semibold mb-4" data-lang="add_mn_title">Matching Night hinzufügen</h2>
                    <div class="mb-4">
                        <label for="mn-chooser" class="block text-sm font-medium mb-1" data-lang="label_who_chooses">Wer wählt?</label>
                        <select id="mn-chooser" class="input-field w-full md:w-1/2 px-3 py-2">
                            <option value="men_choose" data-lang="men_choose_women">Männer wählen Frauen</option>
                            <option value="women_choose" data-lang="women_choose_men">Frauen wählen Männer</option>
                        </select>
                    </div>
                    <div id="mn-pairs-container" class="space-y-4 mb-4">
                        <!-- Pair selectors will be generated here -->
                    </div>
                    <div class="flex items-center space-x-4 mb-4">
                        <label for="mn-lights" class="text-sm font-medium" data-lang="label_lights">Anzahl Lichter:</label>
                        <input type="number" id="mn-lights" min="0" class="input-field w-24 px-3 py-2 text-center">
                    </div>
                    <div id="mn-form-buttons" class="flex items-center space-x-2">
                        <button id="add-mn-button" class="btn btn-primary px-5 py-2" data-lang="btn_save_mn">Matching Night speichern</button>
                    </div>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold mb-3" data-lang="title_previous_mns">Bisherige Matching Nights</h3>
                    <div id="matching-night-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Prognose Tab -->
            <div id="prognose" class="tab-pane hidden">
                 <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold" data-lang="prognosis_title">Prognose: Wahrscheinlichkeiten für Perfect Matches</h2>
                        <button id="recalculate-prognosis" class="btn btn-primary px-4 py-2 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                            <span data-lang="btn_recalculate">Neu berechnen</span>
                        </button>
                    </div>
                    <div id="prognosis-info" class="mb-4 text-gray-300"></div>
                    <div id="prognosis-results" class="prognosis-grid">
                        <!-- Prognosis cards will be generated here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
const translations = {
    de: {
        title: "AYTO-Calculator",
        subtitle: "Match Rechner & Prognose-Tool",
        tab_contestants: "Kandidaten",
        tab_matchboxes: "Matchboxen",
        tab_matching_nights: "Matching Nights",
        tab_prognosis: "Prognose",
        add_contestant_title: "Neuen Kandidaten hinzufügen",
        label_name: "Name",
        label_gender: "Geschlecht",
        gender_male: "Männlich",
        gender_female: "Weiblich",
        btn_add: "Hinzufügen",
        title_men: "Männer",
        title_women: "Frauen",
        add_matchbox_title: "Matchbox Ergebnis hinzufügen",
        label_man: "Mann",
        label_woman: "Frau",
        label_result: "Ergebnis",
        result_perfect_match: "Perfect Match",
        result_no_match: "No Match",
        btn_save: "Speichern",
        title_previous_matchboxes: "Bisherige Matchboxen",
        add_mn_title: "Matching Night hinzufügen",
        edit_mn_title: "Matching Night bearbeiten",
        label_who_chooses: "Wer wählt?",
        men_choose_women: "Männer wählen Frauen",
        women_choose_men: "Frauen wählen Männer",
        label_lights: "Anzahl Lichter:",
        btn_save_mn: "Matching Night speichern",
        btn_update_mn: "Änderungen speichern",
        btn_cancel: "Abbrechen",
        title_previous_mns: "Bisherige Matching Nights",
        prognosis_title: "Prognose: Wahrscheinlichkeiten für Perfect Matches",
        btn_recalculate: "Neu berechnen",
        prognosis_calculating: "Berechne Wahrscheinlichkeiten...",
        prognosis_uneven: "Die Prognose kann nur berechnet werden, wenn die Anzahl der Männer und Frauen gleich ist und nicht null beträgt.",
        prognosis_info_text: "Basierend auf den eingegebenen Daten gibt es <strong class=\"text-cyan-400\">{count}</strong> mögliche korrekte Kombinationen für die verbleibenden Kandidaten.",
        prognosis_info_text_one: "Basierend auf den eingegebenen Daten gibt es <strong class=\"text-cyan-400\">1</strong> mögliche korrekte Kombination für die verbleibenden Kandidaten.",
        prognosis_all_found: "Alle Paare gefunden! Herzlichen Glückwunsch! Es gibt <strong class=\"text-cyan-400\">1</strong> mögliche korrekte Kombination.",
        prognosis_no_combinations: "Keine gültigen Kombinationen für die restlichen Kandidaten gefunden. Bitte überprüfe die Eingaben auf widersprüchliche Informationen.",
        mn_of: "Matching Night",
        lights_of: "Lichter",
        choose_man: "Wähle Mann",
        choose_woman: "Wähle Frau",
        choose_partner: "Wähle Partner",
        choose_female_partner: "Wähle Partnerin",
        add_contestants_first: "Füge zuerst Kandidaten hinzu, um eine Matching Night zu erstellen.",
        // Notifications
        notification_select_pair: "Bitte wähle einen Mann und eine Frau für die Matchbox aus.",
        notification_mn_assign_partner: "Bitte weise jeder Person genau einen Partner zu und stelle sicher, dass keine Duplikate vorhanden sind.",
        notification_mn_lights_invalid: "Bitte gib eine gültige Anzahl an Lichtern an (0 bis {count})."
    },
    en: {
        title: "AYTO-Calculator",
        subtitle: "Match Calculator & Forecast Tool",
        tab_contestants: "Contestants",
        tab_matchboxes: "Matchboxes",
        tab_matching_nights: "Matching Nights",
        tab_prognosis: "Prognosis",
        add_contestant_title: "Add New Contestant",
        label_name: "Name",
        label_gender: "Gender",
        gender_male: "Male",
        gender_female: "Female",
        btn_add: "Add",
        title_men: "Men",
        title_women: "Women",
        add_matchbox_title: "Add Matchbox Result",
        label_man: "Man",
        label_woman: "Woman",
        label_result: "Result",
        result_perfect_match: "Perfect Match",
        result_no_match: "No Match",
        btn_save: "Save",
        title_previous_matchboxes: "Previous Matchboxes",
        add_mn_title: "Add Matching Night",
        edit_mn_title: "Edit Matching Night",
        label_who_chooses: "Who chooses?",
        men_choose_women: "Men choose Women",
        women_choose_men: "Women choose Men",
        label_lights: "Number of Lights:",
        btn_save_mn: "Save Matching Night",
        btn_update_mn: "Save Changes",
        btn_cancel: "Cancel",
        title_previous_mns: "Previous Matching Nights",
        prognosis_title: "Prognosis: Probabilities for Perfect Matches",
        btn_recalculate: "Recalculate",
        prognosis_calculating: "Calculating probabilities...",
        prognosis_uneven: "The prognosis can only be calculated if the number of men and women is equal and not zero.",
        prognosis_info_text: "Based on the entered data, there are <strong class=\"text-cyan-400\">{count}</strong> possible correct combinations for the remaining contestants.",
        prognosis_info_text_one: "Based on the entered data, there is <strong class=\"text-cyan-400\">1</strong> possible correct combination for the remaining contestants.",
        prognosis_all_found: "All pairs found! Congratulations! There is <strong class=\"text-cyan-400\">1</strong> possible correct combination.",
        prognosis_no_combinations: "No valid combinations found for the remaining contestants. Please check the inputs for conflicting information.",
        mn_of: "Matching Night",
        lights_of: "Lights",
        choose_man: "Choose man",
        choose_woman: "Choose woman",
        choose_partner: "Choose partner",
        choose_female_partner: "Choose partner",
        add_contestants_first: "Add contestants first to create a matching night.",
        // Notifications
        notification_select_pair: "Please select a man and a woman for the matchbox.",
        notification_mn_assign_partner: "Please assign exactly one partner to each person and ensure there are no duplicates.",
        notification_mn_lights_invalid: "Please enter a valid number of lights (0 to {count})."
    }
};

const AppState = {
    state: {
        contestants: [],
        matchboxes: [],
        matchingNights: [],
    },
    settings: {
        lang: 'en',
        theme: 'dark',
    },
    editingMatchingNightId: null,

    init() {
        this.loadSettings();
        this.setTheme(this.settings.theme);
        this.setLanguage(this.settings.lang);
        this.loadState();
        this.setupEventListeners();
        this.renderAll();
    },

    setupEventListeners() {
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const newTheme = this.settings.theme === 'dark' ? 'light' : 'dark';
            this.setTheme(newTheme);
        });

        document.getElementById('lang-toggle').addEventListener('click', () => {
            const newLang = this.settings.lang === 'de' ? 'en' : 'de';
            this.setLanguage(newLang);
        });

        document.getElementById('tab-navigation').addEventListener('click', (e) => {
            if (e.target.matches('button[data-tab]')) {
                const tabId = e.target.dataset.tab;
                this.switchTab(tabId);
            }
        });

        document.getElementById('add-contestant-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.name.value.trim();
            const gender = e.target.gender.value;
            if (name) {
                this.addContestant(name, gender);
                e.target.name.value = '';
            }
        });

        document.getElementById('add-matchbox-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const manId = parseInt(e.target['mb-male'].value);
            const womanId = parseInt(e.target['mb-female'].value);
            const result = e.target['mb-result'].value;
            if (!isNaN(manId) && !isNaN(womanId)) {
                this.addMatchbox(manId, womanId, result);
            } else {
                this.showNotification('notification_select_pair');
            }
        });
        
        document.getElementById('mn-form-buttons').addEventListener('click', (e) => {
            if (e.target.id === 'add-mn-button') {
                this.saveMatchingNight();
            } else if (e.target.id === 'cancel-mn-edit-button') {
                this.resetMatchingNightForm();
            }
        });

        document.getElementById('recalculate-prognosis').addEventListener('click', () => this.renderPrognosis());
        document.getElementById('mn-chooser').addEventListener('change', () => this.renderMatchingNights());
        document.getElementById('mn-pairs-container').addEventListener('change', (e) => {
            if (e.target.matches('select')) this.updateMatchingNightDropdowns();
        });
    },
    
    translate(key, replacements = {}) {
        let text = translations[this.settings.lang][key] || key;
        for (const placeholder in replacements) {
            text = text.replace(`{${placeholder}}`, replacements[placeholder]);
        }
        return text;
    },

    setLanguage(lang) {
        this.settings.lang = lang;
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.dataset.lang;
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        document.getElementById('lang-toggle').textContent = lang.toUpperCase();
        this.saveSettings();
        this.renderAll(); // Re-render to update dynamic content
    },
    
    setTheme(theme) {
        this.settings.theme = theme;
        const html = document.documentElement;
        if (theme === 'dark') {
            html.classList.add('dark');
            document.getElementById('theme-icon-dark').classList.remove('hidden');
            document.getElementById('theme-icon-light').classList.add('hidden');
        } else {
            html.classList.remove('dark');
            document.getElementById('theme-icon-dark').classList.add('hidden');
            document.getElementById('theme-icon-light').classList.remove('hidden');
        }
        this.saveSettings();
    },

    // --- State Management ---
    addContestant(name, gender) {
        const newContestant = { id: Date.now(), name, gender };
        this.state.contestants.push(newContestant);
        this.saveAndRender();
    },

    deleteContestant(id) {
        this.state.contestants = this.state.contestants.filter(c => c.id !== id);
        this.state.matchboxes = this.state.matchboxes.filter(mb => mb.manId !== id && mb.womanId !== id);
        this.state.matchingNights.forEach(mn => {
            mn.pairs = mn.pairs.filter(p => p[0] !== id && p[1] !== id);
        });
        this.saveAndRender();
    },
    
    updateContestantName(id, newName) {
        const contestant = this.state.contestants.find(c => c.id === id);
        if (contestant) {
            contestant.name = newName;
            this.saveAndRender();
        }
    },

    addMatchbox(manId, womanId, result) {
        const newMatchbox = { id: Date.now(), manId, womanId, result };
        this.state.matchboxes.push(newMatchbox);
        this.saveAndRender();
    },

    deleteMatchbox(id) {
        this.state.matchboxes = this.state.matchboxes.filter(mb => mb.id !== id);
        this.saveAndRender();
    },
    
    saveMatchingNight() {
        const chooserMode = document.getElementById('mn-chooser').value;
        const confirmedIds = this.getConfirmedPerfectMatchIds();
        const men = this.getContestantsByGender('male').filter(c => !confirmedIds.has(c.id));
        const women = this.getContestantsByGender('female').filter(c => !confirmedIds.has(c.id));
        const pairs = [];
        const selectedPartners = new Set();
        let isValid = true;

        const choosers = (chooserMode === 'men_choose') ? men : women;
        choosers.forEach(chooser => {
            const select = document.getElementById(`mn-select-chooser-${chooser.id}`);
            const partnerId = parseInt(select.value);
            if(isNaN(partnerId) || selectedPartners.has(partnerId)) { 
                isValid = false; 
            }
            selectedPartners.add(partnerId);
            const manId = (chooserMode === 'men_choose') ? chooser.id : partnerId;
            const womanId = (chooserMode === 'men_choose') ? partnerId : chooser.id;
            pairs.push([manId, womanId]);
        });

        const lightsInput = document.getElementById('mn-lights');
        const lights = parseInt(lightsInput.value);
        const expectedPairCount = choosers.length;

        if (!isValid || selectedPartners.size !== expectedPairCount) {
            this.showNotification('notification_mn_assign_partner');
            return;
        }

        if (isNaN(lights) || lights < 0 || lights > expectedPairCount) {
            this.showNotification('notification_mn_lights_invalid', { count: expectedPairCount });
            return;
        }
        
        if (this.editingMatchingNightId) {
            const mnToUpdate = this.state.matchingNights.find(mn => mn.id === this.editingMatchingNightId);
            if (mnToUpdate) {
                Object.assign(mnToUpdate, { pairs, lights, chooserMode });
            }
        } else {
            this.state.matchingNights.push({ id: Date.now(), pairs, lights, chooserMode });
        }
        
        this.editingMatchingNightId = null;
        this.saveAndRender();
    },
    
    deleteMatchingNight(id) {
        this.state.matchingNights = this.state.matchingNights.filter(mn => mn.id !== id);
        this.saveAndRender();
    },

    loadMatchingNightForEdit(id) {
        const mn = this.state.matchingNights.find(m => m.id === id);
        if (!mn) return;

        this.editingMatchingNightId = id;
        document.getElementById('mn-form-title').textContent = this.translate('edit_mn_title');
        const formCard = document.getElementById('mn-form-card');
        formCard.classList.remove('form-highlight');
        void formCard.offsetWidth;
        formCard.classList.add('form-highlight');

        const chooserSelect = document.getElementById('mn-chooser');
        chooserSelect.value = mn.chooserMode;
        chooserSelect.dispatchEvent(new Event('change'));
        
        setTimeout(() => {
            mn.pairs.forEach(([manId, womanId]) => {
                const chooserId = (mn.chooserMode === 'men_choose') ? manId : womanId;
                const partnerId = (mn.chooserMode === 'men_choose') ? womanId : manId;
                const select = document.getElementById(`mn-select-chooser-${chooserId}`);
                if (select) select.value = partnerId;
            });
            this.updateMatchingNightDropdowns();
            document.getElementById('mn-lights').value = mn.lights;
        }, 0);

        const buttonContainer = document.getElementById('mn-form-buttons');
        buttonContainer.innerHTML = `
            <button id="add-mn-button" class="btn btn-primary px-5 py-2">${this.translate('btn_update_mn')}</button>
            <button id="cancel-mn-edit-button" type="button" class="btn bg-gray-600 hover:bg-gray-500 text-white px-5 py-2">${this.translate('btn_cancel')}</button>
        `;

        document.getElementById('matching-nights').querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    },

    resetMatchingNightForm() {
        this.editingMatchingNightId = null;
        this.renderMatchingNights();
    },

    showNotification(messageKey, replacements = {}) {
        const message = this.translate(messageKey, replacements);
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        notif.className = `notification error`;
        notif.textContent = message;
        container.appendChild(notif);
        
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            notif.addEventListener('transitionend', () => notif.remove(), { once: true });
        }, 4000);
    },

    updateMatchingNightDropdowns() {
        const pairsContainer = document.getElementById('mn-pairs-container');
        const selects = pairsContainer.querySelectorAll('select');
        const selectedValues = new Set();
        selects.forEach(select => { if (select.value) selectedValues.add(select.value); });
        selects.forEach(select => {
            const currentSelection = select.value;
            select.querySelectorAll('option').forEach(option => {
                if (option.value) {
                    option.disabled = selectedValues.has(option.value) && option.value !== currentSelection;
                }
            });
        });
    },

    getContestantsByGender: (gender) => AppState.state.contestants.filter(c => c.gender === gender),
    getContestantById: (id) => AppState.state.contestants.find(c => c.id === id),

    getConfirmedPerfectMatchIds() {
        const confirmedIds = new Set();
        this.state.matchboxes.forEach(mb => {
            if (mb.result === 'perfect') {
                confirmedIds.add(mb.manId).add(mb.womanId);
            }
        });
        return confirmedIds;
    },

    // --- Persistence ---
    saveState: () => localStorage.setItem('aytoState', JSON.stringify(AppState.state)),
    loadState() {
        const savedState = localStorage.getItem('aytoState');
        if (savedState) this.state = JSON.parse(savedState);
    },
    saveSettings: () => localStorage.setItem('aytoSettings', JSON.stringify(AppState.settings)),
    loadSettings() {
        const savedSettings = localStorage.getItem('aytoSettings');
        if (savedSettings) this.settings = JSON.parse(savedSettings);
    },
    saveAndRender() {
        this.saveState();
        this.renderAll();
    },

    // --- Rendering ---
    renderAll() {
        this.renderContestants();
        this.renderMatchboxes();
        this.renderMatchingNights();
        if (document.getElementById('prognose').classList.contains('hidden') === false) {
             this.renderPrognosis();
        }
    },

    switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.querySelector(`button[data-tab="${tabId}"]`).classList.add('active');
        if (tabId === 'prognose') this.renderPrognosis();
    },

    renderContestants() {
        const maleContainer = document.getElementById('male-contestants');
        const femaleContainer = document.getElementById('female-contestants');
        maleContainer.innerHTML = '';
        femaleContainer.innerHTML = '';
        this.getContestantsByGender('male').forEach(c => maleContainer.innerHTML += this.createContestantHTML(c));
        this.getContestantsByGender('female').forEach(c => femaleContainer.innerHTML += this.createContestantHTML(c));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteContestant(parseInt(e.currentTarget.dataset.id))));
        document.querySelectorAll('.contestant-name').forEach(el => el.addEventListener('blur', (e) => this.updateContestantName(parseInt(e.currentTarget.dataset.id), e.currentTarget.textContent.trim())));
    },

    createContestantHTML(contestant) {
        return `<div class="card flex items-center justify-between p-3"><span class="contestant-name" contenteditable="true" data-id="${contestant.id}">${contestant.name}</span><button data-id="${contestant.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div>`;
    },

    renderMatchboxes() {
        const listContainer = document.getElementById('matchbox-list');
        const maleSelect = document.getElementById('mb-male');
        const femaleSelect = document.getElementById('mb-female');
        listContainer.innerHTML = '';
        maleSelect.innerHTML = `<option value="">${this.translate('choose_man')}</option>`;
        femaleSelect.innerHTML = `<option value="">${this.translate('choose_woman')}</option>`;
        const confirmedIds = this.getConfirmedPerfectMatchIds();
        this.getContestantsByGender('male').forEach(c => { if (!confirmedIds.has(c.id)) maleSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        this.getContestantsByGender('female').forEach(c => { if (!confirmedIds.has(c.id)) femaleSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        this.state.matchboxes.forEach(mb => {
            const man = this.getContestantById(mb.manId);
            const woman = this.getContestantById(mb.womanId);
            if (man && woman) listContainer.innerHTML += this.createMatchboxHTML(mb, man, woman);
        });
        listContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteMatchbox(parseInt(e.currentTarget.dataset.id))));
    },

    createMatchboxHTML(mb, man, woman) {
        const isPerfect = mb.result === 'perfect';
        const bgColor = isPerfect ? 'bg-green-600/20 border-green-500' : 'bg-red-600/20 border-red-500';
        const textColor = isPerfect ? 'text-green-400' : 'text-red-400';
        const resultText = isPerfect ? this.translate('result_perfect_match') : this.translate('result_no_match');
        return `<div class="card flex items-center justify-between p-4 border-l-4 ${bgColor}"><div class="font-medium"><span>${man.name}</span><span class="text-gray-400 mx-2">&</span><span>${woman.name}</span></div><div class="flex items-center space-x-4"><span class="font-semibold ${textColor}">${resultText}</span><button data-id="${mb.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div></div>`;
    },
    
    renderMatchingNights() {
        const pairsContainer = document.getElementById('mn-pairs-container');
        const listContainer = document.getElementById('matching-night-list');
        const chooserMode = document.getElementById('mn-chooser').value;
        pairsContainer.innerHTML = '';
        listContainer.innerHTML = '';
        
        const confirmedIds = this.getConfirmedPerfectMatchIds();
        const men = this.getContestantsByGender('male').filter(c => !confirmedIds.has(c.id));
        const women = this.getContestantsByGender('female').filter(c => !confirmedIds.has(c.id));
        document.getElementById('mn-lights').max = Math.min(men.length, women.length);

        if (men.length === 0 || women.length === 0) {
            pairsContainer.innerHTML = `<p class="text-gray-400">${this.translate('add_contestants_first')}</p>`;
        } else {
            const [choosers, partners, partnerPlaceholder] = (chooserMode === 'men_choose') ? [men, women, 'choose_female_partner'] : [women, men, 'choose_partner'];
            choosers.forEach(chooser => {
                let options = `<option value="">${this.translate(partnerPlaceholder)}</option>`;
                partners.forEach(partner => { options += `<option value="${partner.id}">${partner.name}</option>`; });
                pairsContainer.innerHTML += `<div class="grid grid-cols-3 gap-4 items-center"><label class="font-medium text-right">${chooser.name}</label><span class="text-center text-gray-400">↔</span><select id="mn-select-chooser-${chooser.id}" class="input-field w-full px-3 py-2">${options}</select></div>`;
            });
        }
        
        this.state.matchingNights.forEach((mn, index) => listContainer.innerHTML += this.createMatchingNightHTML(mn, index + 1));
        listContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteMatchingNight(parseInt(e.currentTarget.dataset.id))));
        listContainer.querySelectorAll('.edit-mn-btn').forEach(btn => btn.addEventListener('click', (e) => this.loadMatchingNightForEdit(parseInt(e.currentTarget.dataset.id))));
    
        if (this.editingMatchingNightId === null) {
            document.getElementById('mn-form-title').textContent = this.translate('add_mn_title');
            document.getElementById('mn-lights').value = '';
            document.getElementById('mn-form-buttons').innerHTML = `<button id="add-mn-button" class="btn btn-primary px-5 py-2">${this.translate('btn_save_mn')}</button>`;
        }
    },

    createMatchingNightHTML(mn, index) {
        let pairsHTML = mn.pairs.map(([manId, womanId]) => {
            const man = this.getContestantById(manId);
            const woman = this.getContestantById(womanId);
            return (man && woman) ? `<div class="p-2 bg-gray-800 rounded-md text-sm">${man.name} - ${woman.name}</div>` : '';
        }).join('');
        return `<div class="card p-4"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold">${this.translate('mn_of')} #${index}</h4><div class="flex items-center space-x-4"><span class="text-lg font-bold text-cyan-400">${mn.lights} ${this.translate('lights_of')}</span><button data-id="${mn.id}" class="edit-mn-btn text-gray-400 hover:text-cyan-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button><button data-id="${mn.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div></div><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${pairsHTML}</div></div>`;
    },

    renderPrognosis() {
        const resultsContainer = document.getElementById('prognosis-results');
        const infoContainer = document.getElementById('prognosis-info');
        resultsContainer.innerHTML = `<div class="text-center col-span-full py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto"></div><p class="mt-4">${this.translate('prognosis_calculating')}</p></div>`;
        infoContainer.innerHTML = '';

        setTimeout(() => {
            const allMen = this.getContestantsByGender('male');
            const allWomen = this.getContestantsByGender('female');

            if (allMen.length !== allWomen.length || allMen.length === 0) {
                resultsContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">${this.translate('prognosis_uneven')}</p>`;
                return;
            }
            
            const confirmedMatches = this.state.matchboxes
                .filter(mb => mb.result === 'perfect')
                .map(mb => ({ manId: mb.manId, womanId: mb.womanId }));
            
            const confirmedIds = new Set(confirmedMatches.flatMap(p => [p.manId, p.womanId]));
            const remainingMen = allMen.filter(c => !confirmedIds.has(c.id));
            const remainingWomen = allWomen.filter(c => !confirmedIds.has(c.id));
            resultsContainer.innerHTML = '';

            confirmedMatches.forEach(pair => {
                resultsContainer.innerHTML += this.createPrognosisCardHTML({ manId: pair.manId, womanId: pair.womanId, prob: 1, isConfirmed: true });
            });

            if (remainingMen.length === 0) {
                 infoContainer.innerHTML = this.translate('prognosis_all_found');
                return;
            }
            
            const { validWorlds, probabilities } = this.calculatePrognosis(remainingMen, remainingWomen, confirmedMatches);
            
            const countText = validWorlds.length === 1 ? 'prognosis_info_text_one' : 'prognosis_info_text';
            infoContainer.innerHTML = this.translate(countText, {count: validWorlds.length.toLocaleString(this.settings.lang)});
            
            if (validWorlds.length === 0) {
                resultsContainer.innerHTML += `<p class="col-span-full text-center text-red-400">${this.translate('prognosis_no_combinations')}</p>`;
                return;
            }
            
            probabilities.sort((a, b) => b.prob - a.prob);
            probabilities.forEach(p => resultsContainer.innerHTML += this.createPrognosisCardHTML(p));
        }, 50);
    },
    
    createPrognosisCardHTML(p) {
        const man = this.getContestantById(p.manId);
        const woman = this.getContestantById(p.womanId);
        const prob = Math.round(p.prob * 100);
        let bgColor;
        if (p.isConfirmed) bgColor = 'bg-pink-500';
        else if (prob === 100) bgColor = 'bg-green-500';
        else if (prob > 70) bgColor = 'bg-teal-500';
        else if (prob > 40) bgColor = 'bg-cyan-500';
        else if (prob > 10) bgColor = 'bg-cyan-600';
        else if (prob > 0) bgColor = 'bg-cyan-700';
        else bgColor = 'bg-red-600';
        const confirmedClasses = p.isConfirmed ? 'border-2 border-yellow-400 shadow-lg' : '';
        return `<div class="card p-4 space-y-2 ${confirmedClasses}"><div class="font-medium text-center">${man.name} & ${woman.name}</div><div class="progress-bar"><div class="progress-bar-inner ${bgColor}" style="width: ${prob}%">${prob}%</div></div></div>`;
    },

    // --- Prognosis Calculation ---
    calculatePrognosis(men, women, confirmedMatches = []) {
        const menIds = men.map(m => m.id);
        const womenIds = women.map(w => w.id);
        let validWorlds = [];

        function* permute(permutation) {
            const length = permutation.length;
            const c = Array(length).fill(0);
            let i = 1, k, p;
            yield permutation.slice();
            while (i < length) {
                if (c[i] < i) {
                    k = i % 2 && c[i];
                    p = permutation[i];
                    permutation[i] = permutation[k];
                    permutation[k] = p;
                    ++c[i];
                    i = 1;
                    yield permutation.slice();
                } else {
                    c[i] = 0;
                    ++i;
                }
            }
        }

        const womenPermutations = permute(womenIds);
        const confirmedPairs = confirmedMatches.map(p => [p.manId, p.womanId]);

        for (const p of womenPermutations) {
            const partialWorld = menIds.map((manId, index) => [manId, p[index]]);
            if (this.isWorldValid(partialWorld, confirmedPairs)) {
                validWorlds.push(partialWorld);
            }
        }
        
        const probabilityMap = new Map();
        men.forEach(man => women.forEach(woman => probabilityMap.set(`${man.id}-${woman.id}`, 0)));
        validWorlds.forEach(world => world.forEach(pair => probabilityMap.set(`${pair[0]}-${pair[1]}`, probabilityMap.get(`${pair[0]}-${pair[1]}`) + 1)));
        
        const probabilities = [];
        for (const [key, count] of probabilityMap.entries()) {
            const [manId, womanId] = key.split('-').map(Number);
            probabilities.push({ manId, womanId, prob: validWorlds.length > 0 ? count / validWorlds.length : 0 });
        }
        
        return { validWorlds, probabilities };
    },

    isWorldValid(partialWorld, confirmedPairs = []) {
        const world = [...partialWorld, ...confirmedPairs];
        for (const mb of this.state.matchboxes) {
            const pairInWorld = world.some(p => p[0] === mb.manId && p[1] === mb.womanId);
            if ((mb.result === 'perfect' && !pairInWorld) || (mb.result === 'no_match' && pairInWorld)) return false;
        }
        for (const mn of this.state.matchingNights) {
            let correctPairs = 0;
            mn.pairs.forEach(mnPair => {
                if (world.some(p => p[0] === mnPair[0] && p[1] === mnPair[1])) correctPairs++;
            });
            if (correctPairs !== mn.lights) return false;
        }
        return true;
    }
};

document.addEventListener('DOMContentLoaded', () => AppState.init());
</script>
</body>
</html>



