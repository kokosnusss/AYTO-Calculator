<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYTO-Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7816446001252728"
         crossorigin="anonymous"></script>
         
    <style>
        :root {
            /* Dark Theme Colors */
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg: #1f2937;
            --border-color: #374151;
            --input-bg: #374151;
            --input-border: #4b5563;
            --hover-bg: #1f2937;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
        }
        html:not(.dark) {
            /* Light Theme Colors */
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --hover-bg: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            color: var(--accent-pink);
            border-bottom-color: var(--accent-pink);
        }
        .tab-button:not(.active):hover {
            background-color: var(--hover-bg);
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
        }
        .input-field {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            color: var(--text-color);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px #0e7490;
        }
        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--accent-cyan);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0891b2;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .prognosis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .progress-bar {
            background-color: var(--input-bg);
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }
        .progress-bar-inner {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
        }
        @keyframes highlight-form {
            from {
                border-color: var(--accent-cyan);
                box-shadow: 0 0 8px rgba(6, 182, 212, 0.5);
            }
            to {
                border-color: var(--border-color);
                box-shadow: none;
            }
        }
        .form-highlight {
            animation: highlight-form 1s ease-out;
        }
        .notification {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-in-out;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.error {
            background-color: #dc2626; /* btn-danger red */
        }
        .notification.success {
            background-color: #16a34a; /* green-600 */
        }
        .main-header-title { color: #ffffff; }
        .main-header-subtitle { color: #9ca3af; } /* text-gray-400 */
        html:not(.dark) .main-header-title { color: #111827; } /* text-gray-900 */
        html:not(.dark) .main-header-subtitle { color: #6b7280; } /* text-gray-500 */
        html:not(.dark) select option:disabled {
            color: #9ca3af; /* text-gray-400 */
        }
        .pair-chip {
            background-color: #374151; /* Corresponds to gray-700, same as input-bg in dark */
        }
        html:not(.dark) .pair-chip {
            background-color: #e5e7eb; /* Corresponds to gray-200 */
        }
        #prognosis-info {
            color: #9ca3af; /* Corresponds to text-gray-400 */
        }
        html:not(.dark) #prognosis-info {
            color: #4b5563; /* Corresponds to text-gray-600 */
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="notification-container" class="fixed top-5 right-5 z-50 space-y-2 w-full max-w-xs"></div>
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center text-center sm:text-left mb-8">
            <div>
                <h1 class="main-header-title text-3xl md:text-4xl font-bold"><span data-lang="title">AYTO-Calculator</span></h1>
                <p class="main-header-subtitle text-lg mt-1" data-lang="subtitle">Match Rechner & Prognose-Tool</p>
            </div>
            <div class="flex items-center space-x-2 justify-center mt-4 sm:mt-0">
                <button id="theme-toggle" class="p-2 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white transition">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sun-fill hidden" viewBox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162h1.212a.217.217 0 0 1 .134.386l-1.002.725.387 1.162a.217.217 0 0 1-.316.228l-1.001-.725-1.002.725a.217.217 0 0 1-.316-.228l.387-1.162-1.002-.725a.217.217 0 0 1 .134-.386h1.212l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a.796.796 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a.796.796 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774.258c.346-.115.617-.386.732-.732L13.863.1z"/></svg>
                </button>
                <button id="lang-toggle" class="p-2 w-10 text-center rounded-full text-sm font-semibold text-gray-400 hover:bg-gray-700 hover:text-white transition">DE</button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-700">
            <nav class="flex -mb-px space-x-4 overflow-x-auto whitespace-nowrap hide-scrollbar" id="tab-navigation">
                <button data-tab="kandidaten" class="tab-button active text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_contestants">Kandidaten</button>
                <button data-tab="matchboxen" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_matchboxes">Matchboxen</button>
                <button data-tab="matching-nights" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_matching_nights">Matching Nights</button>
                <button data-tab="prognose" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_prognosis">Prognose</button>
                <button data-tab="settings" class="tab-button text-base font-medium border-b-2 border-transparent px-4 py-3 whitespace-nowrap" data-lang="tab_settings">Einstellungen</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main id="tab-content">
            <!-- Kandidaten Tab -->
            <div id="kandidaten" class="tab-pane">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4" data-lang="add_contestant_title">Kandidat hinzufügen</h2>
                        <form id="add-contestant-form" class="space-y-4">
                            <div>
                                <label for="contestant-name" class="block text-sm font-medium mb-1" data-lang="label_name">Name</label>
                                <input type="text" id="contestant-name" class="input-field w-full px-3 py-2">
                            </div>
                            <div>
                                <label for="contestant-gender" class="block text-sm font-medium mb-1" data-lang="label_gender">Geschlecht</label>
                                <select id="contestant-gender" class="input-field w-full px-3 py-2">
                                    <option value="male" data-lang="gender_male">Männlich</option>
                                    <option value="female" data-lang="gender_female">Weiblich</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-full py-2" data-lang="btn_add_contestant">Kandidat hinzufügen</button>
                        </form>
                    </div>
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4" data-lang="contestants_list_title">Kandidatenliste</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6">
                            <div>
                                <h3 class="font-medium mb-2" data-lang="gender_male">Männlich</h3>
                                <ul id="male-list" class="space-y-1"></ul>
                            </div>
                            <div>
                                <h3 class="font-medium mb-2" data-lang="gender_female">Weiblich</h3>
                                <ul id="female-list" class="space-y-1"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matchboxen Tab -->
            <div id="matchboxen" class="tab-pane hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4" data-lang="add_matchbox_title">Matchbox hinzufügen</h2>
                        <form id="add-matchbox-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="mb-male" class="input-field w-full px-3 py-2"></select>
                                <select id="mb-female" class="input-field w-full px-3 py-2"></select>
                            </div>
                            <div>
                                <label for="mb-result" class="block text-sm font-medium mb-1" data-lang="label_result">Ergebnis</label>
                                <select id="mb-result" class="input-field w-full px-3 py-2">
                                    <option value="perfect" data-lang="result_perfect">Perfect Match</option>
                                    <option value="no_match" data-lang="result_no_match">No Match</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-full py-2" data-lang="btn_add_matchbox">Matchbox speichern</button>
                        </form>
                    </div>
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4" data-lang="matchbox_history_title">Matchbox-Verlauf</h2>
                        <ul id="matchbox-list" class="space-y-2"></ul>
                    </div>
                </div>
            </div>

            <!-- Matching Nights Tab -->
            <div id="matching-nights" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div id="mn-form-card" class="card p-6">
                        <h2 id="mn-form-title" class="text-xl font-semibold mb-4" data-lang="add_mn_title">Matching Night hinzufügen</h2>
                        <div class="mb-4">
                            <label for="mn-chooser" class="block text-sm font-medium mb-1" data-lang="label_chooser">Wer wählt?</label>
                            <select id="mn-chooser" class="input-field w-full md:w-1/2 px-3 py-2">
                                <option value="men_choose" data-lang="chooser_men">Männer wählen</option>
                                <option value="women_choose" data-lang="chooser_women">Frauen wählen</option>
                            </select>
                        </div>
                        <div id="mn-pairs-container" class="grid grid-cols-1 gap-4 mb-4"></div>
                        <div class="flex items-center space-x-4 mb-4">
                            <label for="mn-lights" class="block text-sm font-medium" data-lang="label_lights">Anzahl Lichter:</label>
                            <input type="number" id="mn-lights" min="0" class="input-field w-24 px-3 py-2">
                        </div>
                        <div id="mn-form-buttons" class="flex space-x-2">
                            <button id="add-mn-button" class="btn btn-primary px-5 py-2" data-lang="btn_save_mn">Matching Night speichern</button>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4" data-lang="mn_history_title">Matching Night-Verlauf</h2>
                        <div id="matching-night-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Prognose Tab -->
            <div id="prognose" class="tab-pane hidden">
                <div class="card p-6">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold" data-lang="prognosis_title">Prognose: Wahrscheinlichkeiten für Perfect Matches</h2>
                        <button id="recalculate-prognosis" class="btn btn-primary px-4 py-2 space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                            <span data-lang="btn_recalculate">Neu berechnen</span>
                        </button>
                    </div>
                    <div id="prognosis-info" class="mb-4"></div>
                    <div id="prognosis-results" class="prognosis-grid">
                        <!-- Prognosis cards will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-pane hidden">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4" data-lang="settings_title">Einstellungen</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-medium mb-2" data-lang="settings_reset_title">Daten zurücksetzen</h3>
                            <p class="text-sm text-gray-400 mb-3" data-lang="settings_reset_desc">Dies löscht alle eingegebenen Kandidaten, Matchboxen und Matching Nights. Diese Aktion kann nicht rückgängig gemacht werden.</p>
                            <button id="reset-app-btn" class="btn btn-danger px-5 py-2" data-lang="btn_reset_app">App zurücksetzen</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div class="my-8 flex justify-center">
            
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-7816446001252728"
                 data-ad-slot="8594611513"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirmation-modal" class="modal-overlay hidden">
        <div class="card p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold mb-2" data-lang="modal_reset_title">Bist du sicher?</h3>
            <p class="mb-6" data-lang="modal_reset_text">Möchtest du wirklich alle Daten zurücksetzen? Dies kann nicht rückgängig gemacht werden.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-reset-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white px-5 py-2" data-lang="btn_cancel">Abbrechen</button>
                <button id="confirm-reset-btn" class="btn btn-danger px-5 py-2" data-lang="btn_confirm_reset">Ja, zurücksetzen</button>
            </div>
        </div>
    </div>

<script>
const translations = {
    de: {
        title: "AYTO-Calculator",
        subtitle: "Match Rechner & Prognose-Tool",
        tab_contestants: "Kandidaten",
        tab_matchboxes: "Matchboxen",
        tab_matching_nights: "Matching Nights",
        tab_prognosis: "Prognose",
        tab_settings: "Einstellungen",
        settings_title: "Einstellungen",
        settings_reset_title: "Daten zurücksetzen",
        settings_reset_desc: "Dies löscht alle eingegebenen Kandidaten, Matchboxen und Matching Nights. Diese Aktion kann nicht rückgängig gemacht werden.",
        btn_reset_app: "App zurücksetzen",
        modal_reset_title: "Bist du sicher?",
        modal_reset_text: "Möchtest du wirklich alle Daten zurücksetzen? Dies kann nicht rückgängig gemacht werden.",
        btn_confirm_reset: "Ja, zurücksetzen",
        notification_app_reset: "Anwendung wurde zurückgesetzt!",
        add_contestant_title: "Kandidat hinzufügen",
        label_name: "Name",
        label_gender: "Geschlecht",
        gender_male: "Männlich",
        gender_female: "Weiblich",
        btn_add_contestant: "Kandidat hinzufügen",
        contestants_list_title: "Kandidatenliste",
        add_matchbox_title: "Matchbox hinzufügen",
        label_result: "Ergebnis",
        result_perfect: "Perfect Match",
        result_no_match: "No Match",
        btn_add_matchbox: "Matchbox speichern",
        matchbox_history_title: "Matchbox-Verlauf",
        add_mn_title: "Matching Night hinzufügen",
        label_chooser: "Wer wählt?",
        chooser_men: "Männer wählen",
        chooser_women: "Frauen wählen",
        label_lights: "Anzahl Lichter:",
        btn_save_mn: "Matching Night speichern",
        mn_history_title: "Matching Night-Verlauf",
        prognosis_title: "Prognose: Wahrscheinlichkeiten für Perfect Matches",
        btn_recalculate: "Neu berechnen",
        notification_contestant_added: "Kandidat hinzugefügt!",
        notification_contestant_removed: "Kandidat entfernt.",
        notification_name_updated: "Name aktualisiert.",
        notification_select_pair: "Bitte wähle einen Mann und eine Frau für die Matchbox aus.",
        notification_duplicate_partner: "Bitte weise jeder Person genau einen Partner zu und stelle sicher, dass keine Duplikate vorhanden sind.",
        notification_valid_lights: "Bitte gib eine gültige Anzahl an Lichtern an (0 bis {count}).",
        mn_of: "Matching Night",
        lights_of: "Lichter",
        btn_edit: "Bearbeiten",
        btn_save_changes: "Änderungen speichern",
        btn_cancel: "Abbrechen",
        edit_mn_title: "Matching Night bearbeiten",
        prognosis_no_combinations: "Es gibt keine gültigen Kombinationen mehr, die zu den eingegebenen Daten passen. Überprüfe deine Eingaben.",
        prognosis_calculating: "Berechne Wahrscheinlichkeiten...",
        prognosis_uneven: "Die Prognose kann nur berechnet werden, wenn mindestens ein Mann und eine Frau vorhanden sind.",
        prognosis_info_text: "Basierend auf den eingegebenen Daten gibt es <strong class=\"text-cyan-400\">{count}</strong> mögliche korrekte Kombinationen für die verbleibenden Kandidaten.",
        prognosis_info_text_one: "Basierend auf den eingegebenen Daten gibt es <strong class=\"text-cyan-400\">1</strong> mögliche korrekte Kombination für die verbleibenden Kandidaten.",
    },
    en: {
        title: "AYTO-Calculator",
        subtitle: "Match Calculator & Prognosis Tool",
        tab_contestants: "Contestants",
        tab_matchboxes: "Matchboxes",
        tab_matching_nights: "Matching Nights",
        tab_prognosis: "Prognosis",
        tab_settings: "Settings",
        settings_title: "Settings",
        settings_reset_title: "Reset Data",
        settings_reset_desc: "This will delete all entered contestants, matchboxes, and matching nights. This action cannot be undone.",
        btn_reset_app: "Reset App",
        modal_reset_title: "Are you sure?",
        modal_reset_text: "Do you really want to reset all data? This cannot be undone.",
        btn_confirm_reset: "Yes, reset",
        notification_app_reset: "Application has been reset!",
        add_contestant_title: "Add Contestant",
        label_name: "Name",
        label_gender: "Gender",
        gender_male: "Male",
        gender_female: "Female",
        btn_add_contestant: "Add Contestant",
        contestants_list_title: "Contestants List",
        add_matchbox_title: "Add Matchbox",
        label_result: "Result",
        result_perfect: "Perfect Match",
        result_no_match: "No Match",
        btn_add_matchbox: "Save Matchbox",
        matchbox_history_title: "Matchbox History",
        add_mn_title: "Add Matching Night",
        label_chooser: "Who chooses?",
        chooser_men: "Men choose",
        chooser_women: "Women choose",
        label_lights: "Number of lights:",
        btn_save_mn: "Save Matching Night",
        mn_history_title: "Matching Night History",
        prognosis_title: "Prognosis: Probabilities for Perfect Matches",
        btn_recalculate: "Recalculate",
        notification_contestant_added: "Contestant added!",
        notification_contestant_removed: "Contestant removed.",
        notification_name_updated: "Name updated.",
        notification_select_pair: "Please select a man and a woman for the Matchbox.",
        notification_duplicate_partner: "Please assign exactly one partner to each person and ensure there are no duplicates.",
        notification_valid_lights: "Please enter a valid number of lights (0 to {count}).",
        mn_of: "Matching Night",
        lights_of: "Lights",
        btn_edit: "Edit",
        btn_save_changes: "Save Changes",
        btn_cancel: "Cancel",
        edit_mn_title: "Edit Matching Night",
        prognosis_no_combinations: "There are no valid combinations left that fit the entered data. Please check your inputs.",
        prognosis_calculating: "Calculating probabilities...",
        prognosis_uneven: "The prognosis can only be calculated if there is at least one man and one woman.",
        prognosis_info_text: "Based on the entered data, there are <strong class=\"text-cyan-400\">{count}</strong> possible correct combinations for the remaining contestants.",
        prognosis_info_text_one: "Based on the entered data, there is <strong class=\"text-cyan-400\">1</strong> possible correct combination for the remaining contestants.",
    }
};

const AppState = {
    state: {
        contestants: [],
        matchboxes: [],
        matchingNights: [],
    },
    settings: {
        lang: 'en',
        theme: 'dark',
    },
    editingMatchingNightId: null,

    init() {
        this.loadSettings();
        this.setTheme(this.settings.theme);
        this.setLanguage(this.settings.lang);
        this.loadState();
        this.setupEventListeners();
        this.renderAll();
    },

    saveState() {
        localStorage.setItem('aytoState', JSON.stringify(this.state));
    },

    loadState() {
        const savedState = localStorage.getItem('aytoState');
        if (savedState) {
            this.state = JSON.parse(savedState);
        }
    },

    saveSettings() {
        localStorage.setItem('aytoSettings', JSON.stringify(this.settings));
    },

    loadSettings() {
        const savedSettings = localStorage.getItem('aytoSettings');
        if (savedSettings) {
            this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
        }
    },

    setupEventListeners() {
        // Tab navigation
        document.getElementById('tab-navigation').addEventListener('click', (e) => {
            if (e.target.matches('[data-tab]')) {
                this.setActiveTab(e.target.dataset.tab);
            }
        });

        // Add Contestant form
        document.getElementById('add-contestant-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = e.target['contestant-name'];
            const genderSelect = e.target['contestant-gender'];
            const name = nameInput.value.trim();
            if (name) {
                this.addContestant(name, genderSelect.value);
                nameInput.value = ''; // Keep gender selected
                nameInput.focus();
            }
        });

        // Add Matchbox form
        document.getElementById('add-matchbox-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const manId = parseInt(e.target['mb-male'].value);
            const womanId = parseInt(e.target['mb-female'].value);
            const result = e.target['mb-result'].value;
            if (!isNaN(manId) && !isNaN(womanId)) {
                this.addMatchbox(manId, womanId, result);
            } else {
                this.showNotification('notification_select_pair');
            }
        });
        
        // Matching Night chooser change
        document.getElementById('mn-chooser').addEventListener('change', () => this.renderMatchingNightForm());

        // Matching Night form buttons (Save/Update/Cancel)
        document.getElementById('mn-form-buttons').addEventListener('click', (e) => {
            if (e.target.id === 'add-mn-button') {
                this.saveMatchingNight();
            } else if (e.target.id === 'cancel-mn-edit-button') {
                this.resetMatchingNightForm();
            }
        });

        // Recalculate prognosis button
        document.getElementById('recalculate-prognosis').addEventListener('click', () => {
            this.renderPrognosis();
        });

        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', () => {
            this.setTheme(this.settings.theme === 'dark' ? 'light' : 'dark');
            this.saveSettings();
        });

        // Language toggle
        document.getElementById('lang-toggle').addEventListener('click', () => {
            this.setLanguage(this.settings.lang === 'de' ? 'en' : 'de');
            this.saveSettings();
        });
        
        // Reset App button
        document.getElementById('reset-app-btn').addEventListener('click', () => this.showResetModal());
        document.getElementById('confirm-reset-btn').addEventListener('click', () => {
            this.resetApp();
            this.hideResetModal();
        });
        document.getElementById('cancel-reset-btn').addEventListener('click', () => this.hideResetModal());
        document.getElementById('reset-confirmation-modal').addEventListener('click', (e) => {
            if (e.target.id === 'reset-confirmation-modal') {
                this.hideResetModal();
            }
        });
    },

    setTheme(theme) {
        this.settings.theme = theme;
        const root = document.documentElement;
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');
        if (theme === 'dark') {
            root.classList.add('dark');
            lightIcon.classList.remove('hidden');
            darkIcon.classList.add('hidden');
        } else {
            root.classList.remove('dark');
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        }
    },

    setLanguage(lang) {
        this.settings.lang = lang;
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.dataset.lang;
            const translation = this.translate(key);
            if (translation) {
                // If the element has a placeholder, set it, otherwise set textContent
                if (el.placeholder !== undefined) {
                    el.placeholder = translation;
                } else {
                    el.innerHTML = translation; // Use innerHTML to support strong tags
                }
            }
        });
        document.getElementById('lang-toggle').textContent = lang.toUpperCase();
        this.renderAll(); // Rerender to update dynamic content
    },
    
    translate(key, replacements = {}) {
        let translation = translations[this.settings.lang][key] || translations['en'][key] || `[${key}]`;
        Object.keys(replacements).forEach(rKey => {
            translation = translation.replace(`{${rKey}}`, replacements[rKey]);
        });
        return translation;
    },

    setActiveTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
        document.getElementById(tabId)?.classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.toggle('active', button.dataset.tab === tabId);
        });
        
        if(tabId === 'prognose') {
            this.renderPrognosis();
        }
    },
    
    saveAndRender() {
        this.saveState();
        this.renderAll();
    },

    renderAll() {
        this.renderContestants();
        this.renderMatchboxes();
        this.renderMatchingNights();
        // Avoid auto-recalculating prognosis on every change for performance
        if (document.getElementById('prognose').classList.contains('hidden') === false) {
             this.renderPrognosis();
        }
    },

    // --- Contestant Logic ---
    addContestant(name, gender) {
        this.state.contestants.push({ id: Date.now(), name, gender });
        this.showNotification('notification_contestant_added', 'success');
        this.saveAndRender();
    },
    
    getContestantById(id) {
        return this.state.contestants.find(c => c.id === id);
    },

    getContestantsByGender(gender) {
        return this.state.contestants.filter(c => c.gender === gender);
    },

    removeContestant(id) {
        this.state.contestants = this.state.contestants.filter(c => c.id !== id);
        // Also remove from any pairs etc.
        this.state.matchboxes = this.state.matchboxes.filter(mb => mb.manId !== id && mb.womanId !== id);
        this.state.matchingNights.forEach(mn => {
            mn.pairs = mn.pairs.filter(p => p[0] !== id && p[1] !== id);
        });
        this.showNotification('notification_contestant_removed', 'success');
        this.saveAndRender();
    },

    updateContestantName(id, newName) {
        const contestant = this.getContestantById(id);
        if (contestant) {
            contestant.name = newName;
            this.showNotification('notification_name_updated', 'success');
            this.saveAndRender();
        }
    },

    renderContestants() {
        const maleList = document.getElementById('male-list');
        const femaleList = document.getElementById('female-list');
        maleList.innerHTML = '';
        femaleList.innerHTML = '';

        this.state.contestants.forEach(c => {
            const list = c.gender === 'male' ? maleList : femaleList;
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 rounded-md hover:bg-[var(--hover-bg)]';
            li.innerHTML = `
                <span contenteditable="true" class="flex-grow focus:outline-none focus:ring-2 focus:ring-cyan-500 rounded px-1">${c.name}</span>
                <button data-id="${c.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors ml-2 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                </button>`;
            
            const nameSpan = li.querySelector('span');
            nameSpan.addEventListener('blur', () => this.updateContestantName(c.id, nameSpan.textContent.trim()));
            nameSpan.addEventListener('keydown', (e) => {
                if(e.key === 'Enter') {
                    e.preventDefault();
                    nameSpan.blur();
                }
            });

            li.querySelector('.delete-btn').addEventListener('click', () => this.removeContestant(c.id));
            list.appendChild(li);
        });
    },
    
    // --- Matchbox Logic ---
    getConfirmedPerfectMatchIds() {
        return new Set(this.state.matchboxes.filter(mb => mb.result === 'perfect').flatMap(mb => [mb.manId, mb.womanId]));
    },
    
    addMatchbox(manId, womanId, result) {
        this.state.matchboxes.push({ id: Date.now(), manId, womanId, result });
        this.saveAndRender();
    },

    deleteMatchbox(id) {
        this.state.matchboxes = this.state.matchboxes.filter(mb => mb.id !== id);
        this.saveAndRender();
    },

    renderMatchboxes() {
        const maleSelect = document.getElementById('mb-male');
        const femaleSelect = document.getElementById('mb-female');
        const listContainer = document.getElementById('matchbox-list');
        
        maleSelect.innerHTML = `<option selected disabled>${this.translate('gender_male')}</option>`;
        femaleSelect.innerHTML = `<option selected disabled>${this.translate('gender_female')}</option>`;
        listContainer.innerHTML = '';

        const confirmedIds = this.getConfirmedPerfectMatchIds();
        
        this.getContestantsByGender('male').filter(c => !confirmedIds.has(c.id)).forEach(c => {
            maleSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
        this.getContestantsByGender('female').filter(c => !confirmedIds.has(c.id)).forEach(c => {
            femaleSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });

        this.state.matchboxes.forEach(mb => {
            const man = this.getContestantById(mb.manId);
            const woman = this.getContestantById(mb.womanId);
            if (!man || !woman) return;

            const resultText = this.translate(mb.result === 'perfect' ? 'result_perfect' : 'result_no_match');
            const resultColor = mb.result === 'perfect' ? 'text-green-400' : 'text-red-400';

            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 rounded-md';
            li.innerHTML = `
                <span>${man.name} & ${woman.name}</span>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold ${resultColor}">${resultText}</span>
                    <button data-id="${mb.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    </button>
                </div>`;
            li.querySelector('.delete-btn').addEventListener('click', () => this.deleteMatchbox(mb.id));
            listContainer.appendChild(li);
        });
    },

    // --- Matching Night Logic ---
    saveMatchingNight() {
        const chooserMode = document.getElementById('mn-chooser').value;
        const confirmedIds = this.getConfirmedPerfectMatchIds();
        const men = this.getContestantsByGender('male').filter(c => !confirmedIds.has(c.id));
        const women = this.getContestantsByGender('female').filter(c => !confirmedIds.has(c.id));
        const pairs = [];
        const selectedPartners = new Set();
        let isValid = true;

        const choosers = (chooserMode === 'men_choose') ? men : women;
        choosers.forEach(chooser => {
            const select = document.getElementById(`mn-select-chooser-${chooser.id}`);
            const partnerId = parseInt(select.value);
            if(isNaN(partnerId)) { isValid = false; }
            if(selectedPartners.has(partnerId)) { isValid = false; }
            selectedPartners.add(partnerId);
            const manId = (chooserMode === 'men_choose') ? chooser.id : partnerId;
            const womanId = (chooserMode === 'men_choose') ? partnerId : chooser.id;
            pairs.push([manId, womanId]);
        });

        const lightsInput = document.getElementById('mn-lights');
        const lights = parseInt(lightsInput.value);

        const expectedPairCount = choosers.length;

        if (!isValid || pairs.length !== expectedPairCount) {
            this.showNotification('notification_duplicate_partner');
            return;
        }

        if (isNaN(lights) || lights < 0 || lights > expectedPairCount) {
            this.showNotification('notification_valid_lights', {count: expectedPairCount});
            return;
        }
        
        if (this.editingMatchingNightId) {
            const mnToUpdate = this.state.matchingNights.find(mn => mn.id === this.editingMatchingNightId);
            if (mnToUpdate) {
                mnToUpdate.pairs = pairs;
                mnToUpdate.lights = lights;
                mnToUpdate.chooserMode = chooserMode;
            }
        } else {
            this.state.matchingNights.push({ id: Date.now(), pairs, lights, chooserMode });
        }
        
        this.resetMatchingNightForm();
    },
    
    deleteMatchingNight(id) {
        this.state.matchingNights = this.state.matchingNights.filter(mn => mn.id !== id);
        this.saveAndRender();
    },
    
    loadMatchingNightForEdit(id) {
        const mn = this.state.matchingNights.find(m => m.id === id);
        if (!mn) return;

        this.editingMatchingNightId = id;

        document.getElementById('mn-form-title').innerHTML = this.translate('edit_mn_title');
        
        const formCard = document.getElementById('mn-form-card');
        formCard.classList.remove('form-highlight');
        void formCard.offsetWidth;
        formCard.classList.add('form-highlight');
        formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

        const chooserSelect = document.getElementById('mn-chooser');
        chooserSelect.value = mn.chooserMode;
        
        this.renderMatchingNightForm(() => {
             mn.pairs.forEach(([manId, womanId]) => {
                const chooserId = mn.chooserMode === 'men_choose' ? manId : womanId;
                const partnerId = mn.chooserMode === 'men_choose' ? womanId : manId;
                const select = document.getElementById(`mn-select-chooser-${chooserId}`);
                if(select) select.value = partnerId;
            });
            this.updateMatchingNightDropdowns();
        });
        
        document.getElementById('mn-lights').value = mn.lights;

        const buttonContainer = document.getElementById('mn-form-buttons');
        buttonContainer.innerHTML = `
            <button id="add-mn-button" class="btn btn-primary px-5 py-2">${this.translate('btn_save_changes')}</button>
            <button id="cancel-mn-edit-button" type="button" class="btn bg-gray-600 hover:bg-gray-500 text-white px-5 py-2">${this.translate('btn_cancel')}</button>`;
    },

    resetMatchingNightForm() {
        this.editingMatchingNightId = null;
        this.saveAndRender();
    },

    updateMatchingNightDropdowns() {
        const pairsContainer = document.getElementById('mn-pairs-container');
        const selects = Array.from(pairsContainer.querySelectorAll('select'));
        const selectedValues = new Set();
        
        selects.forEach(select => {
            if(select.value !== 'none') {
                 selectedValues.add(select.value);
            }
        });

        selects.forEach(select => {
            Array.from(select.options).forEach(option => {
                option.disabled = selectedValues.has(option.value) && select.value !== option.value;
            });
        });
    },

    renderMatchingNightForm(callback) {
        const chooserMode = document.getElementById('mn-chooser').value;
        const container = document.getElementById('mn-pairs-container');
        const lightsInput = document.getElementById('mn-lights');
        container.innerHTML = '';

        const confirmedIds = this.getConfirmedPerfectMatchIds();
        const men = this.getContestantsByGender('male').filter(c => !confirmedIds.has(c.id));
        const women = this.getContestantsByGender('female').filter(c => !confirmedIds.has(c.id));

        const choosers = (chooserMode === 'men_choose') ? men : women;
        const partners = (chooserMode === 'men_choose') ? women : men;
        
        lightsInput.max = choosers.length;

        choosers.forEach(chooser => {
            const partnerOptions = partners.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-[1fr_2fr] items-center gap-4';
            div.innerHTML = `
                <label for="mn-select-chooser-${chooser.id}" class="block text-sm font-medium text-right">${chooser.name}</label>
                <select id="mn-select-chooser-${chooser.id}" class="input-field w-full px-3 py-2">
                    <option value="none" selected disabled>Select Partner</option>
                    ${partnerOptions}
                </select>
            `;
            container.appendChild(div);
        });

        container.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => this.updateMatchingNightDropdowns());
        });
        
        if(typeof callback === 'function') callback();
    },

    renderMatchingNights() {
        const listContainer = document.getElementById('matching-night-list');
        listContainer.innerHTML = '';
        
        // Render the form first
        this.renderMatchingNightForm();
        
        // Then render the list
        this.state.matchingNights.forEach((mn, index) => {
            listContainer.innerHTML += this.createMatchingNightHTML(mn, index + 1);
        });
        
        listContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteMatchingNight(parseInt(e.currentTarget.dataset.id))));
        listContainer.querySelectorAll('.edit-mn-btn').forEach(btn => btn.addEventListener('click', (e) => this.loadMatchingNightForEdit(parseInt(e.currentTarget.dataset.id))));
    
        if (this.editingMatchingNightId === null) {
            document.getElementById('mn-form-title').innerHTML = this.translate('add_mn_title');
            document.getElementById('mn-lights').value = '';
            const buttonContainer = document.getElementById('mn-form-buttons');
            buttonContainer.innerHTML = `<button id="add-mn-button" class="btn btn-primary px-5 py-2">${this.translate('btn_save_mn')}</button>`;
        }
    },

    createMatchingNightHTML(mn, index) {
        let pairsHTML = mn.pairs.map(([manId, womanId]) => {
            const man = this.getContestantById(manId);
            const woman = this.getContestantById(womanId);
            return (man && woman) ? `<div class="p-2 pair-chip rounded-md text-sm">${man.name} - ${woman.name}</div>` : '';
        }).join('');
        return `<div class="card p-4"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold">${this.translate('mn_of')} #${index}</h4><div class="flex items-center space-x-4"><span class="text-lg font-bold text-cyan-400">${mn.lights} ${this.translate('lights_of')}</span><button data-id="${mn.id}" class="edit-mn-btn text-gray-400 hover:text-cyan-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button><button data-id="${mn.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div></div><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${pairsHTML}</div></div>`;
    },

    // --- App Reset and Modal Logic ---
    showResetModal() {
        document.getElementById('reset-confirmation-modal').classList.remove('hidden');
    },

    hideResetModal() {
        document.getElementById('reset-confirmation-modal').classList.add('hidden');
    },

    resetApp() {
        this.state = {
            contestants: [],
            matchboxes: [],
            matchingNights: [],
        };
        this.showNotification('notification_app_reset', 'success');
        this.saveAndRender();
    },
    
    showNotification(messageKey, type = 'error') {
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = this.translate(messageKey);
        if (type === 'success') {
            notif.classList.add('bg-green-600');
        }
        container.appendChild(notif);
        
        setTimeout(() => { notif.classList.add('show'); }, 10);
        setTimeout(() => {
            notif.classList.remove('show');
            notif.addEventListener('transitionend', () => notif.remove(), { once: true });
        }, 4000);
    },
    
    // --- Prognosis Rendering ---
    renderPrognosis() {
        const resultsContainer = document.getElementById('prognosis-results');
        const infoContainer = document.getElementById('prognosis-info');
        resultsContainer.innerHTML = `<div class="text-center col-span-full py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto"></div><p class="mt-4">${this.translate('prognosis_calculating')}</p></div>`;
        infoContainer.innerHTML = '';

        setTimeout(() => {
            const allMen = this.getContestantsByGender('male');
            const allWomen = this.getContestantsByGender('female');

            if (allMen.length === 0 || allWomen.length === 0) {
                resultsContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">${this.translate('prognosis_uneven')}</p>`;
                return;
            }
            
            const confirmedMatches = this.state.matchboxes
                .filter(mb => mb.result === 'perfect')
                .map(mb => ({ manId: mb.manId, womanId: mb.womanId }));

            const confirmedIds = new Set(confirmedMatches.flatMap(p => [p.manId, p.womanId]));
            const remainingMen = allMen.filter(c => !confirmedIds.has(c.id));
            const remainingWomen = allWomen.filter(c => !confirmedIds.has(c.id));
            
            resultsContainer.innerHTML = '';
            confirmedMatches.forEach(p => resultsContainer.innerHTML += this.createPrognosisCardHTML({ ...p, prob: 1, isConfirmed: true }));

            if (remainingMen.length === 0 || remainingWomen.length === 0) {
                 infoContainer.innerHTML = ''; // Clear info if only confirmed matches exist
                 return;
            }
            
            const { validWorlds, probabilities } = this.calculatePrognosis(remainingMen, remainingWomen, confirmedMatches);
            
            const countText = validWorlds.length === 1 ? 'prognosis_info_text_one' : 'prognosis_info_text';
            infoContainer.innerHTML = this.translate(countText, {count: validWorlds.length.toLocaleString(this.settings.lang)});
            
            if (validWorlds.length === 0 && (remainingMen.length > 0 || remainingWomen.length > 0)) {
                 resultsContainer.innerHTML += `<p class="col-span-full text-center text-red-400">${this.translate('prognosis_no_combinations')}</p>`;
                 return;
            }
            
            const newlySolvedPairs = probabilities.filter(p => p.prob === 1);
            const newlySolvedIds = new Set(newlySolvedPairs.flatMap(p => [p.manId, p.womanId]));

            const filteredProbabilities = probabilities.filter(p => {
                if (p.prob === 1) return true;
                return !newlySolvedIds.has(p.manId) && !newlySolvedIds.has(p.womanId);
            });
            
            filteredProbabilities.sort((a, b) => b.prob - a.prob);
            filteredProbabilities.forEach(p => resultsContainer.innerHTML += this.createPrognosisCardHTML(p));
        }, 50);
    },
    
    createPrognosisCardHTML(p) {
        const man = this.getContestantById(p.manId);
        const woman = this.getContestantById(p.womanId);
        if (!man || !woman) return '';
        const prob = Math.round(p.prob * 100);
        
        let bgColor;
        let extraCardClasses = '';
        let namesHTML = `${man.name} & ${woman.name}`;

        if (p.isConfirmed) {
            bgColor = 'bg-pink-500';
        } else if (prob === 100) {
            bgColor = 'bg-green-500';
        } else if (prob > 70) {
            bgColor = 'bg-teal-500';
        } else if (prob > 40) {
            bgColor = 'bg-cyan-500';
        } else if (prob > 10) {
            bgColor = 'bg-cyan-600';
        } else if (prob > 0) {
            bgColor = 'bg-cyan-700';
        } else {
            bgColor = 'bg-red-600';
            extraCardClasses = 'opacity-60';
            namesHTML = `<span class="line-through">${man.name} & ${woman.name}</span>`;
        }
        
        const confirmedClasses = p.isConfirmed ? 'border-2 border-yellow-400 shadow-lg' : '';
        const barWidth = prob > 0 ? prob : 100;

        return `<div class="card p-4 space-y-2 ${confirmedClasses} ${extraCardClasses}"><div class="font-medium text-center">${namesHTML}</div><div class="progress-bar"><div class="progress-bar-inner ${bgColor}" style="width: ${barWidth}%">${prob}%</div></div></div>`;
    },

    // --- Prognosis Calculation ---
    calculatePrognosis(men, women, confirmedMatches = []) {
        const isMenSmaller = men.length <= women.length;
        const smallerGroup = isMenSmaller ? men : women;
        const largerGroup = isMenSmaller ? women : men;

        const smallerIds = smallerGroup.map(c => c.id);
        const largerIds = largerGroup.map(c => c.id);
        let validWorlds = [];

        function* combinations(arr, k) {
            if (k < 0 || k > arr.length) return;
            if (k === 0) { yield []; return; }
            if (arr.length === 0) return;
            const [first, ...rest] = arr;
            for (const combo of combinations(rest, k - 1)) {
                yield [first, ...combo];
            }
            for (const combo of combinations(rest, k)) {
                yield combo;
            }
        }
        
        function* permute(permutation) {
            const length = permutation.length;
            if (length === 0) { yield []; return; }
            const c = Array(length).fill(0);
            let i = 1;
            yield permutation.slice();
            while (i < length) {
                if (c[i] < i) {
                    const k = i % 2 ? c[i] : 0;
                    [permutation[i], permutation[k]] = [permutation[k], permutation[i]];
                    ++c[i];
                    i = 1;
                    yield permutation.slice();
                } else {
                    c[i] = 0;
                    ++i;
                }
            }
        }

        const largerGroupCombinations = combinations(largerIds, smallerIds.length);
        const confirmedPairs = confirmedMatches.map(p => [p.manId, p.womanId]);

        for (const combo of largerGroupCombinations) {
            const permutationsOfCombo = permute(combo);
            for (const p of permutationsOfCombo) {
                const partialWorld = smallerIds.map((id, index) => {
                    const manId = isMenSmaller ? id : p[index];
                    const womanId = isMenSmaller ? p[index] : id;
                    return [manId, womanId];
                });
                if (this.isWorldValid(partialWorld, confirmedPairs)) {
                    validWorlds.push(partialWorld);
                }
            }
        }
        
        const probabilityMap = new Map();
        men.forEach(man => women.forEach(woman => probabilityMap.set(`${man.id}-${woman.id}`, 0)));
        
        validWorlds.forEach(world => {
            world.forEach(pair => {
                const key = `${pair[0]}-${pair[1]}`;
                if (probabilityMap.has(key)) {
                    probabilityMap.set(key, probabilityMap.get(key) + 1);
                }
            });
        });
        
        const probabilities = [];
        for (const [key, count] of probabilityMap.entries()) {
            const [manId, womanId] = key.split('-').map(Number);
            probabilities.push({ manId, womanId, prob: validWorlds.length > 0 ? count / validWorlds.length : 0 });
        }
        
        return { validWorlds, probabilities };
    },

    isWorldValid(partialWorld, confirmedPairs = []) {
        const world = [...partialWorld, ...confirmedPairs];
        for (const mb of this.state.matchboxes) {
            const isPairInWorld = world.some(p => p[0] === mb.manId && p[1] === mb.womanId);
            if (mb.result === 'perfect' && !isPairInWorld) return false;
            if (mb.result === 'no_match' && isPairInWorld) return false;
        }

        for (const mn of this.state.matchingNights) {
            let correctBeams = 0;
            mn.pairs.forEach(pair => {
                if (world.some(p => p[0] === pair[0] && p[1] === pair[1])) {
                    correctBeams++;
                }
            });
            if (correctBeams !== mn.lights) return false;
        }
        return true;
    }
};

document.addEventListener('DOMContentLoaded', () => {
    AppState.init();
});

</script>

<script data-goatcounter="https://kokosnusss.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

</body>
</html>
